receive_dict = { "identifier" : "10",
    "terminalID" : "",
    "sourceID" : "",
    "sequentialNumber" : "",
    "transactionType" : "",
    "transactionFlag" : "",
    "transactionNumber" : "",
    "batchNumber" : "",
    "transactionDate" : "",
    "transactionTime" : "",
    "fieldSeparator1" : "",
    "transactionAmount1" : "",
    "fieldSeparator2" : "",
    "fieldSeparator3" : "",
    "amountExponent" : "+0",
    "fieldSeparator4" : "",
    "amountCurrency" : "705",
    "fieldSeparator5" : "",
    "cardDataSource" : "",
    "fieldSeparator6" : "",
    "cardNumber" : "",
    "fieldSeparator7" : "",
    "expirationDate" : "",
    "fieldSeparator8" : "",
    "fieldSeparator9" : "",
    "fieldSeparator10" : "",
    "authorizationCode" : "",
    "fieldSeparator11" : "",
    "tidNumber" : "",
    "fieldSeparator12" : "",
    "midNumber" : "",
    "fieldSeparator13" : "",
    "companyName" : "",
    "fieldSeparator14" : "",
    "fieldSeparator15" : "",
    "fieldSeparator16" : "",
    "fieldSeparator17" : "",
    "fieldSeparator18" : "",
    "fieldSeparator19" : "",
    "fieldSeparator20" : "",
    "displayMessage" : "",
    "fieldSeparator21" : "",
    "fieldSeparator22" : "",
    "inputData" : "",
    "fieldSeparator23" : "",
    "emvData" : "",
    "fieldSeparator24" : "",
    "signatureLinePrintFlag" : "",
    "fieldSeparator25" : "",
    "acquirerName" : "",
    "debitTransactionCount" : "",
    "debitTransactionAmount" : "",
    "refundTransactionCount" : "",
    "refundTransactionAmount" : "",
    "fieldSeparator26" : "",
    "moreMessagesFlag" : "",
    "fieldSeparator27" : "",
    "installmentsNumber" : "",
    "fieldSeparator28" : "",
    "fullResponseCode" : "",
    "fieldSeparator29" : "",
    "transactionStatus" : "",
    "fieldSeparator30" : "",
    "spdhTerminalTotals" : "",
    "fieldSeparator31" : "",
    "spdhHostTotals" : "",
    "fieldSeparator32" : "",
    "pinBlock" : "",
    "fieldSeparator33" : "",
    "cardholderName" : "",
    "fieldSeparator34" : "",
    "rrn" : "",
    "fieldSeparator35" : "",
    "pinFlag" : "",
    "fieldSeparator36" : "",
    "transactionAmount2" : "",
    "fieldSeparator37" : "",
    "payservicesData" : "",
    "fieldSeparator38" : "",
    "availableBalance" : "",
    "fieldSeparator39" : "",
    "offlineCryptogram" : "",
    "fieldSeparator40" : "",
    "loyaltyData" : "",
    "fieldSeparator41" : "",
    "formattedTextToPrint" : "",
    "fieldSeparator42" : "",
    "dccNumber" : "",
    "fieldSeparator43" : "",
    "dccProvider" : "",
    "fieldSeparator44" : "",
    "dccExchangeRate" : "",
    "fieldSeparator45" : "",
    "dccExchangeRateDate" : "",
    "fieldSeparator46" : "",
    "dccMarkUpPercent" : "",
    "fieldSeparator47" : "",
    "dccAmount" : "",
    "fieldSeparator48" : "",
    "dccDisclaimer" : "",
    "fieldSeparator49" : "",
    "dccStatus" : "",
    "fieldSeparator50" : "",
    "dccCurrencySymbol" : "",
    "fieldSeparator51" : "",
    "instantPaymentReference" : "",
    "fieldSeparator52" : "",
    "personal_vehicleCardData" : "",
    "fieldSeparator53" : "",
    "mifareCardType" : "",
    "fieldSeparator54" : "",
    "mifareCardUID" : "",
    "fieldSeparator55" : "",
    "f4gCode" : "",
    "fieldSeparator56" : "",
    "radcom_transportationSpecificData" : "",
    "fieldSeparator57" : "",
    "acquirerId" : "",
    "fieldSeparator58" : "",
    "transactionID" : "",
    "fieldSeparator59" : "",
}

dict20 = { 
    "identifier" : "20",
    "00" : "",
    "00" : "",
    "00" : "",
    "displayMessage" : ""
}

dict22 = { 
    "identifier" : "26",
    "00" : "",
    "00" : "",
    "00" : "",
    "displayMessage" : ""
}


dict30 = { 
    "identifier" : "30",
    "00" : "",
    "00" : "",
    "00" : "",
    "cardDataSource" : "",
    "fieldSeparator1" : "",
    "cardHash" : "",
    "fieldSeparator2" : ""
}

dict23 = { 
    "identifier" : "23",
    "00" : "",
    "00" : "",
    "00" : ""
}

dict24 = { 
    "identifier" : "24",
    "00" : "",
    "00" : "",
    "00" : "",
    "responseMessage" : ""
}


dict25 = { 
    "identifier" : "25",
    "00" : "",
    "00" : "",
    "00" : "",
    "displayMessage" : "",
    "fieldSeparator1" : "",
    "code" : "",
    "fieldSeparator2" : "",
}

dict26 = { 
    "identifier" : "26",
    "00" : "",
    "00" : "",
    "00" : "",
    "displayMessage" : "",
    "fieldSeparator1" : "",
    "code" : "",
    "fieldSeparator2" : "",
}

dict27 = { 
    "identifier" : "27",
    "00" : "",
    "00" : "",
    "00" : "",
    "commandType" : "",
    "commandDataLength" : "",
    "commandData" : "",
}


dict28 = { 
    "identifier" : "28",
    "00" : "",
    "00" : "",
    "00" : "",
    "commandResponseStatus" : "",
    "responseLength" : "",
    "responseData" : "",
}



dict31 = { 
    "identifier" : "31",
    "functionNumber" : "",
    "fieldSeparator1" : "",
    "password" : "",
    "fieldSeparator2" : "",
    "additionalData" : "",
    "fieldSeparator1" : "",
}


dict32 = { 
    "identifier" : "31",
    "status" : "",
    "fieldSeparator1" : "",
    "responseMessage" : "",
    "fieldSeparator2" : ""
}


dict33 = { 
    "identifier" : "33",
    "00" : "",
    "00" : "",
    "00" : "",
    "transactionNumber" : "",
    "radcom" : "",
    "fieldSeparator1" : "",
}


dict34 = { 
    "identifier" : "34",
    "00" : "",
    "00" : "",
    "00" : "",
    "status" : "",
    "radcom" : "",
    "fieldSeparator1" : "",
}


dict29 = { 
    "identifier" : "29",
    "00" : "",
    "00" : "",
    "00" : "",
    "transactionNumber" : "",
    "radcom" : "",
    "fieldSeparator1" : "",
}





# socket_echo_client.py
import binascii
import socket
import sys
import time

send_dict = { "identifier" : "3030",
    "terminalID" : "3030",
    "sourceID" : "3030",
    "sequentialNumber" : "30303030",
    "transactionType" : "3034",
    "printerFlag" : "30",
    "cashierID" : "3030",
    "transactionNumber" : "",
    "fieldSeparator1" : "1C",
    "transactionAmount1" : "32",
    "fieldSeparator2" : "1C",
    "fieldSeparator3" : "1C",
    "amountExponent" : "2B30",
    "fieldSeparator4" : "1C",
    "amountCurrency" : "393431",
    "fieldSeparator5" : "1C",
    "fieldSeparator6" : "1C",
    "fieldSeparator7" : "1C",
    "fieldSeparator8" : "1C",
    "authorizationCode" : "",
    "fieldSeparator9" : "1C",
    "fieldSeparator10" : "1C",
    "fieldSeparator11" : "1C",
    "inputLabel" : "",
    "fieldSeparator12" : "1C",
    "insurancePolicyNumber" : "",
    "fieldSeparator13" : "1C",
    "installmentsNumber" : "",
    "fieldSeparator14" : "1C",
    "minimumInputLenght" : "",
    "maximumInputLenght" :"",
    "maskInputData" : "",
    "fieldSeparator15" : "1C",
    "languageID" : "3030",
    "fieldSeparator16" : "1C",
    "printData" : "",
    "fieldSeparator17" : "1C",
    "cashierID2" : "",
    "fieldSeparator18" : "1C",
    "transactionAmount2" : "",
    "fieldSeparator19" : "1C",
    "payservicesData" : "",
    "fieldSeparator20" : "1C",
    "transactionActivationCode" : "",
    "fieldSeparator21" : "1C",
    "instantPaymentReference" : "",
    "fieldSeparator22" : "1C",
    "qrCodeData" : "",
    "fieldSeparator23" : "1C",
    "specificProcessingFlag" : "",
    "fieldSeparator24" : "1C",
    "random_transportationSpecificData" : ""
}

msg = b'\x0210000000001020000060006311023165313\x1c000000000001\x1c\x1c+0\x1c941\x1cC\x1c5258389999999999999\x1c99\x1c\x1c\x1c697503\x1cUPTTEST19\x1c11111111\x1cMASTERCARD\x1c\x1c\x1c\x1c\x1c\x1c\x1cODOBRENO                 \x1c\x1c\x1c8407A0000000041010950500000080019F120A4D6173746572636172649F2608FA3099456E686A449F2701809F34031F0302\x1c1\x1c\x1c0\x1c\x1c00\x1cC1\x1c\x1c\x1c\x1c\x1c444410324444\x1c0\x1c\x1c\x1c\x1c\x1c\x1c\x1c\x1c\x1c\x1c\x1c\x1c000000000000\x1c\x1c\x1c\x1c\x1c\x1c\x1c\x1c\x1c\x1c01\x1c\x1c\x1c\x1c\x1c\x03d'.decode()



STX = "02"
ETX = "03"
EOT = "04"
ACK = "06"
NACK = "15"


message_data = ""




def xor_sum(message):
    lrc = 0

    for i in range(0, len(message)-1, 2):
        
        b = message[i:i+2]
        lrc ^= int(b, 16)

    return hex(lrc)[2:4]








for key in send_dict:
    
    message_data = str(message_data) + str(send_dict[key])



message_data = message_data + str(ETX)
ack_message_data_tmp = ACK + ETX
nack_message_data_tmp = NACK + ETX

lrc = xor_sum(message_data)
print("*******")

print(lrc)
print("*******")
# lrc_ack = xor_sum(ack_message_data_tmp)
# lrc_nack = xor_sum(nack_message_data_tmp)


message_data = STX+STX+message_data+str(lrc)
# ack_message_data = STX+STX+ack_message_data_tmp+str(lrc_ack)
# nack_message_data = STX+STX+nack_message_data_tmp+str(12)
print("provera 1")
print(message_data)
print("end provera 1")
# str_to_send = "02023030303030303030303030313030301C311C1C2B301C3934311C1C1C1C1C1C1C1C1C1C1C30301C1C1C1C1C1C1C1C1C0324"
# dobar_format = bytearray.fromhex(message_data).decode()
# print("...................")
# print(bytes(dobar_format, encoding='iso-8859-2'))






S_TCP_IP = '192.168.1.101'  
S_TCP_PORT = 3000



TCP_IP = '192.168.1.113'    
TCP_PORT = 3000   

sock_payten = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
status = sock_payten.connect((TCP_IP, TCP_PORT))
print(status)

print(sock_payten)



dobar_format = bytearray.fromhex(message_data).decode()
print("...................")
print(bytes(dobar_format, encoding='iso-8859-2'))

i = 1

try:
    
    
    for i in range(1):



        sent = sock_payten.sendto(bytes(dobar_format, encoding='iso-8859-2'),(TCP_IP,TCP_PORT))

        data = sock_payten.recv(1024)
        # print("************")
        print("Data recived: ")
        print(data.hex())
        print("************")

        if data.hex() == ACK:
            data = sock_payten.recv(1024)
            print("Data recived AFTER the payment: ")
            print(data)
            print("************")
            sent = sock_payten.sendto(bytes(ACK, encoding='iso-8859-2'),(TCP_IP,TCP_PORT))
            hold = True
            while hold == True:
            
                data = sock_payten.recv(1024)
                print("while **********************")
                print(data)
                print("**********************")
                time.sleep(3)

                message_identifier = data.hex()
                print(message_identifier[2:6])
                if message_identifier[2:6] == "3130":   # kod 10
                    print('u if petlji')
                    hold = False
            
            sent = sock_payten.sendto(bytes(ACK, encoding='iso-8859-2'),(TCP_IP,TCP_PORT))
            print("Transakcija uspesno realizovana")

              
      


 
except:
    print("Ode na except")




finally:




    # print(format(data))
    print('closing socket')
    # sock.close()

